# Configuration de s√©curit√© - Contr√¥le d'acc√®s par r√¥le

## üìã Matrice de contr√¥le d'acc√®s

### UTILISATEURS

| Action | ADMIN | RH | MEDECIN | INFIRMIER | PHARMACIEN | RECEPTIONNISTE |
|--------|-------|----|---------|-----------|-----------|----|
| **Lister** | ‚úÖ | ‚úÖ | ‚úÖ (lecture) | ‚ùå | ‚ùå | ‚ùå |
| **Voir d√©tails** | ‚úÖ | ‚úÖ | ‚úÖ (lecture) | ‚ùå | ‚ùå | ‚ùå |
| **Cr√©er** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Modifier** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Supprimer** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Reset password** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Verrouiller compte** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **G√©rer 2FA** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

### PATIENTS

| Action | ADMIN | RH | MEDECIN | INFIRMIER | PHARMACIEN | RECEPTIONNISTE |
|--------|-------|----|---------|-----------|-----------|----|
| **Lister** | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Voir d√©tails** | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **Cr√©er** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ÔøΩÔøΩÔøΩ |
| **Modifier** | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚úÖ |
| **Supprimer** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

### CONSULTATIONS

| Action | ADMIN | RH | MEDECIN | INFIRMIER | PHARMACIEN | RECEPTIONNISTE |
|--------|-------|----|---------|-----------|-----------|----|
| **Lister** | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Voir d√©tails** | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| **Cr√©er** | ‚úÖ | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| **Modifier** | ‚úÖ | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå |
| **Supprimer** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

### DOSSIERS M√âDICAUX

| Action | ADMIN | RH | MEDECIN | INFIRMIER | PHARMACIEN | RECEPTIONNISTE |
|--------|-------|----|---------|-----------|-----------|----|
| **Lister** | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| **Voir d√©tails** | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ | ‚úÖ | ‚ùå |
| **Cr√©er** | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå |
| **Modifier** | ‚úÖ | ‚ùå | ‚ùå | ‚úÖ | ‚ùå | ‚ùå |
| **Supprimer** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

### AFFECTATIONS

| Action | ADMIN | RH | MEDECIN | INFIRMIER | PHARMACIEN | RECEPTIONNISTE |
|--------|-------|----|---------|-----------|-----------|----|
| **Lister** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Voir d√©tails** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Cr√©er** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Modifier** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Supprimer** | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

### MENUS & PERMISSIONS

| Action | ADMIN | RH | MEDECIN | INFIRMIER | PHARMACIEN | RECEPTIONNISTE |
|--------|-------|----|---------|-----------|-----------|----|
| **Lister** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Cr√©er** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Modifier** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **Supprimer** | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

---

## üîê Impl√©mentation dans les contr√¥leurs

### Exemple 1: Endpoint de cr√©ation (POST)

```php
#[Route('', name: 'create', methods: ['POST'])]
public function create(Request $request, PermissionService $permissionService): JsonResponse
{
    try {
        // V√©rifier que l'utilisateur est ADMIN ou RH
        $permissionService->requireAnyRole(['ADMIN', 'RH']);
        
        // ... reste du code
    } catch (AccessDeniedException $e) {
        return $this->json([
            'success' => false,
            'error' => 'Acc√®s refus√©: ' . $e->getMessage(),
        ], 403);
    }
}
```

### Exemple 2: Endpoint de modification (PUT)

```php
#[Route('/{id}', name: 'update', methods: ['PUT'])]
public function update(int $id, Request $request, PermissionService $permissionService): JsonResponse
{
    try {
        // V√©rifier que l'utilisateur est ADMIN ou RH
        $permissionService->requireAnyRole(['ADMIN', 'RH']);
        
        // ... reste du code
    } catch (AccessDeniedException $e) {
        return $this->json([
            'success' => false,
            'error' => 'Acc√®s refus√©: ' . $e->getMessage(),
        ], 403);
    }
}
```

### Exemple 3: Endpoint de lecture (GET)

```php
#[Route('', name: 'list', methods: ['GET'])]
public function list(Request $request, PermissionService $permissionService): JsonResponse
{
    try {
        // V√©rifier que l'utilisateur a au moins un r√¥le autoris√©
        $permissionService->requireAnyRole(['ADMIN', 'RH', 'MEDECIN', 'INFIRMIER', 'PHARMACIEN', 'RECEPTIONNISTE']);
        
        // ... reste du code
    } catch (AccessDeniedException $e) {
        return $this->json([
            'success' => false,
            'error' => 'Acc√®s refus√©: ' . $e->getMessage(),
        ], 403);
    }
}
```

---

## üéØ Endpoints √† s√©curiser

### UTILISATEURS (UtilisateursControllers)

- ‚úÖ `GET /api/utilisateurs` - Lecture: ADMIN, RH, MEDECIN
- ‚úÖ `GET /api/utilisateurs/{id}` - Lecture: ADMIN, RH, MEDECIN
- ‚ùå `POST /api/utilisateurs` - Cr√©ation: ADMIN, RH
- ‚ùå `PUT /api/utilisateurs/{id}` - Modification: ADMIN, RH
- ‚ùå `DELETE /api/utilisateurs/{id}` - Suppression: ADMIN, RH
- ‚ùå `POST /api/utilisateurs/{id}/reset-password` - ADMIN, RH
- ‚ùå `POST /api/utilisateurs/{id}/lock` - ADMIN, RH
- ‚ùå `POST /api/utilisateurs/{id}/2fa` - ADMIN, RH

### PATIENTS (PatientController)

- ‚úÖ `GET /api/patients` - Lecture: ADMIN, MEDECIN, INFIRMIER, PHARMACIEN, RECEPTIONNISTE
- ‚úÖ `GET /api/patients/{id}` - Lecture: ADMIN, MEDECIN, INFIRMIER, PHARMACIEN, RECEPTIONNISTE
- ‚ùå `POST /api/patients` - Cr√©ation: ADMIN, RECEPTIONNISTE
- ‚ùå `PUT /api/patients/{id}` - Modification: ADMIN, INFIRMIER, RECEPTIONNISTE
- ‚ùå `DELETE /api/patients/{id}` - Suppression: ADMIN

### CONSULTATIONS (ConsultationsController)

- ‚úÖ `GET /api/consultations` - Lecture: ADMIN, MEDECIN, INFIRMIER
- ‚úÖ `GET /api/consultations/{id}` - Lecture: ADMIN, MEDECIN, INFIRMIER
- ‚ùå `POST /api/consultations` - Cr√©ation: ADMIN, MEDECIN
- ‚ùå `PUT /api/consultations/{id}` - Modification: ADMIN, MEDECIN
- ‚ùå `DELETE /api/consultations/{id}` - Suppression: ADMIN

### DOSSIERS M√âDICAUX (DossierMedicauxController)

- ‚úÖ `GET /api/dossiers-medicaux` - Lecture: ADMIN, MEDECIN, INFIRMIER, PHARMACIEN
- ‚úÖ `GET /api/dossiers-medicaux/{id}` - Lecture: ADMIN, MEDECIN, INFIRMIER, PHARMACIEN
- ‚ùå `POST /api/dossiers-medicaux` - Cr√©ation: ADMIN, INFIRMIER
- ‚ùå `PUT /api/dossiers-medicaux/{id}` - Modification: ADMIN, INFIRMIER
- ‚ùå `DELETE /api/dossiers-medicaux/{id}` - Suppression: ADMIN

### AFFECTATIONS (AffectationsUtilisateursController)

- ‚úÖ `GET /api/affectations` - Lecture: ADMIN, RH
- ‚úÖ `GET /api/affectations/{id}` - Lecture: ADMIN, RH
- ‚ùå `POST /api/affectations` - CrÔøΩÔøΩation: ADMIN, RH
- ‚ùå `PUT /api/affectations/{id}` - Modification: ADMIN, RH
- ‚ùå `DELETE /api/affectations/{id}` - Suppression: ADMIN, RH

### MENUS & PERMISSIONS (MenusPermissionsController)

- ‚úÖ `GET /api/administrations/menus` - Lecture: ADMIN
- ‚ùå `POST /api/administrations/menus` - Cr√©ation: ADMIN
- ‚ùå `PUT /api/administrations/menus/{id}` - Modification: ADMIN
- ‚ùå `DELETE /api/administrations/menus/{id}` - Suppression: ADMIN
- ‚úÖ `GET /api/administrations/permissions` - Lecture: ADMIN
- ‚ùå `POST /api/administrations/permissions` - Cr√©ation: ADMIN
- ‚ùå `PUT /api/administrations/permissions/{id}` - Modification: ADMIN
- ‚ùå `DELETE /api/administrations/permissions/{id}` - Suppression: ADMIN

---

## üìù Codes d'erreur

| Code | Signification |
|------|---------------|
| 200 | OK - Requ√™te r√©ussie |
| 201 | Created - Ressource cr√©√©e |
| 400 | Bad Request - Donn√©es invalides |
| 401 | Unauthorized - Non authentifi√© |
| 403 | Forbidden - Acc√®s refus√© (permission insuffisante) |
| 404 | Not Found - Ressource non trouv√©e |
| 409 | Conflict - Conflit (ex: doublon) |
| 500 | Internal Server Error - Erreur serveur |

---

## üöÄ Prochaines √©tapes

1. ‚úÖ Cr√©er le service PermissionService
2. ‚úÖ Cr√©er le contr√¥leur AuthInfoController
3. ‚è≥ Ajouter les v√©rifications dans tous les contr√¥leurs
4. ‚è≥ Tester chaque endpoint
5. ‚è≥ Documenter les erreurs 403

---

**Note:** Les v√©rifications doivent √™tre ajout√©es au d√©but de chaque m√©thode sensible.
